steps:
  - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '1.9.8'

  - task: AWSShellScript@1
    displayName: 'Terraform Init with Backend'
    inputs:
      awsCredentials: '$(AWS_SERVICE_CONNECTION)'
      regionName: '$(AWS_REGION)'
      scriptType: 'inline'
      inlineScript: |
        terraform init \
          -input=false \
          -backend-config="bucket=$(TF_STATE_BUCKET)" \
          -backend-config="key=$(TF_STATE_KEY)" \
          -backend-config="region=$(AWS_REGION)" \
          -backend-config="encrypt=true"

  - task: AWSShellScript@1
    displayName: 'Terraform Plan'
    inputs:
      awsCredentials: '$(AWS_SERVICE_CONNECTION)'
      regionName: '$(AWS_REGION)'
      scriptType: 'inline'
      inlineScript: |
        terraform plan \
          -input=false \
          -out=$(Build.SourcesDirectory)/tfplan \
          -var-file="terraform.tfvars"
        
        echo "=== Plan Summary ==="
        terraform show -no-color $(Build.SourcesDirectory)/tfplan | tail -20
        
        echo "=== Verifying plan file exists ==="
        ls -la $(Build.SourcesDirectory)/tfplan

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Plan Artifact'
    inputs:
      targetPath: '$(Build.SourcesDirectory)/tfplan'
      artifact: 'tfplan-$(Build.BuildId)'
      publishLocation: 'pipeline'