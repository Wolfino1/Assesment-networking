steps:
  - task: TerraformInstaller@1
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '1.9.8'

  - task: DownloadPipelineArtifact@2
    displayName: 'Download Plan Artifact'
    inputs:
      artifact: 'tfplan-$(Build.BuildId)'
      path: '$(System.DefaultWorkingDirectory)'

  - task: AWSShellScript@1
    displayName: 'Terraform Init with Backend'
    inputs:
      awsCredentials: '$(AWS_SERVICE_CONNECTION)'
      regionName: '$(AWS_REGION)'
      scriptType: 'inline'
      inlineScript: |
        terraform init \
          -input=false \
          -backend-config="bucket=$(TF_STATE_BUCKET)" \
          -backend-config="key=$(TF_STATE_KEY)" \
          -backend-config="region=$(AWS_REGION)" \
          -backend-config="dynamodb_table=$(TF_STATE_DYNAMODB)" \
          -backend-config="encrypt=true"

  - task: AWSShellScript@1
    displayName: 'Terraform Apply'
    inputs:
      awsCredentials: '$(AWS_SERVICE_CONNECTION)'
      regionName: '$(AWS_REGION)'
      scriptType: 'inline'
      inlineScript: |
        terraform apply \
          -input=false \
          -auto-approve \
          tfplan
        
        echo "=== Outputs ==="
        terraform output